<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>LAM Weekly Market Brief</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* â”€â”€ ë³€ìˆ˜ ë° ìŠ¤íƒ€ì¼ ì„¤ì • â”€â”€ */
    :root { 
      --orange: #FF8C00; 
      --bg-gray: #f4f7f9; 
      --bg-label: #fff9f0; /* í’ˆëª©ëª… ë² ì´ì§€ ë°°ê²½ */
      --border-label: #ffe8cc; 
      --text-main: #2d3436;
      --up: #e74c3c; 
      --down: #3498db; 
      --black: #000000; /* ë¸”ë™ ê·¸ë˜í”„ ìƒ‰ìƒ */
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
    body { background-color: var(--bg-gray); color: var(--text-main); overflow-x: hidden; }

    /* â”€â”€ í—¤ë” â”€â”€ */
    .header { 
      background: white; padding: 15px 25px; border-bottom: 4px solid var(--orange);
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .logo { font-size: 1.5em; font-weight: 950; display: flex; align-items: center; gap: 10px; }
    .logo span { color: var(--orange); }
    
    .toolbar { display: flex; gap: 8px; align-items: center; }
    .t-btn { 
      padding: 8px 15px; border-radius: 8px; border: 1px solid #d1d8e0; background: white; 
      cursor: pointer; font-weight: 800; font-size: 0.85em; display: flex; align-items: center; gap: 6px; 
    }
    .btn-kakao { background: #fae100; border-color: #fae100; }
    .btn-img { background: #3498db; border-color: #3498db; color: white; }
    .btn-new { background: #ff4757; color: white; border: none; padding: 8px 18px; }

    /* â”€â”€ ë¦¬í¬íŠ¸ ì˜ì—­ â”€â”€ */
    .container { max-width: 1400px; margin: 0 auto; padding: 25px; }
    .report-card { background: white; border-radius: 15px; padding: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
    .report-title { font-size: 1.7em; font-weight: 900; color: #333; }
    .week-text { font-weight: 800; color: #666; font-size: 1.1em; }

    /* â”€â”€ í’ˆëª© ì¹´ë“œ ë ˆì´ì•„ì›ƒ â”€â”€ */
    .item-row { 
      background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; 
      display: flex; align-items: center; gap: 0; border: 1.5px solid #edf2f7;
    }
    
    .name-box { 
      flex: 0 0 170px; height: 75px; display: flex; align-items: center; justify-content: center; 
      background: var(--bg-label); border: 2px solid var(--border-label); border-radius: 10px; 
      font-size: 1.5em; font-weight: 950; color: #444; 
    }
    
    .price-col { flex: 0 0 180px; text-align: right; padding-right: 25px; }
    .p-main { font-size: 2em; font-weight: 950; display: block; line-height: 1; }
    .p-unit { font-size: 0.45em; color: #999; margin-left: 3px; }
    .change-badge { margin-top: 8px; display: inline-block; padding: 4px 10px; border-radius: 6px; font-weight: 800; font-size: 1em; }
    .up-bg { background: #fff1f0; color: var(--up); }
    .down-bg { background: #f0f7ff; color: var(--down); }
    .flat-bg { background: #f5f6f7; color: #777; }

    /* ì½”ë©˜íŠ¸ ì˜ì—­ (ì˜¤ë Œì§€ ë¼ì¸ í¬ì¸íŠ¸) */
    .comm-col { 
      flex: 1; font-size: 1.35em; font-weight: 900; color: #2d3436; line-height: 1.6; 
      white-space: pre-wrap; padding: 5px 25px; border-left: 6px solid var(--orange); margin: 0 20px; 
    }

    .action-col { flex: 0 0 430px; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
    .chart-area { width: 100%; display: flex; gap: 10px; align-items: center; justify-content: flex-end; }
    #wti_chart_div { width: 260px; height: 130px; }
    .wti-mini-table { font-size: 0.75em; width: 120px; border-collapse: collapse; }
    .wti-mini-table td { border: 1px solid #f1f5f9; padding: 3px; text-align: center; font-weight: 800; }
    .edit-btn { padding: 5px 12px; border-radius: 5px; border: 1px solid #ddd; background: #fafafa; font-size: 0.75em; font-weight: 800; cursor: pointer; }

    /* â”€â”€ ë°˜ì‘í˜• ë° ìº¡ì³ â”€â”€ */
    @media (max-width: 1200px) {
      .item-row { flex-direction: column; align-items: flex-start; gap: 15px; }
      .name-box, .price-col, .comm-col, .action-col { width: 100%; text-align: left; padding: 0; flex: none; border: none; margin: 0; }
      .comm-col { padding: 15px; background: #fcfcfc; border-left: 6px solid var(--orange); border-radius: 0 8px 8px 0; }
    }
    .capture-mode { width: 1800px !important; padding: 40px !important; }
    .capture-mode .item-row { flex-direction: row !important; display: flex !important; }

    /* â”€â”€ ëª¨ë‹¬ â”€â”€ */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
    .modal-content { background: white; width: 95%; max-width: 650px; padding: 30px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }
    .m-title { font-weight: 950; font-size: 1.6em; color: var(--orange); margin-bottom: 20px; border-bottom: 3px solid var(--orange); padding-bottom: 10px; }
    .m-input { width: 100%; padding: 15px; margin-bottom: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1.1em; }
    .m-save-btn { background: var(--orange); color: white; border: none; padding: 18px; border-radius: 12px; width: 100%; font-weight: 950; cursor: pointer; font-size: 1.3em; }

    #toast { visibility: hidden; position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); color: #fff; padding: 15px 40px; border-radius: 50px; z-index: 5000; font-weight: 900; }
    #toast.show { visibility: visible; animation: fadein 0.5s; }
    @keyframes fadein { from {opacity: 0; bottom: 30px;} to {opacity: 1; bottom: 50px;} }
  </style>
</head>
<body>

  <header class="header">
    <div class="logo">LAM <span>Weekly Brief</span></div>
    <div class="toolbar">
      <button class="t-btn" onclick="location.reload()"><i class="fas fa-sync-alt"></i></button>
      <button class="t-btn btn-kakao" onclick="copyToKakao()"><i class="fas fa-comment"></i> ì¹´í†¡ë³µì‚¬</button>
      <button class="t-btn btn-img" onclick="takeCapture()"><i class="fas fa-file-image"></i> ì´ë¯¸ì§€ ì €ì¥</button>
      <select id="weekSelector" onchange="loadData(this.value)" style="padding: 8px; border-radius: 6px; font-weight: 800; border: 2px solid var(--orange); outline:none;"></select>
      <button class="t-btn btn-new" onclick="openNewReport()">+ NEW</button>
    </div>
  </header>

  <div class="container">
    <div class="report-card" id="captureArea">
      <div class="report-header">
        <h2 class="report-title">Weekly Market Status Report</h2>
        <div class="week-text" id="displayWeek">Week: 2026-W00</div>
      </div>
      <div id="mainRows"></div>
    </div>
  </div>

  <div id="mModal" class="modal">
    <div class="modal-content">
      <div class="m-title" id="mTitle">ë°ì´í„° ê´€ë¦¬</div>
      <div id="mFields"></div>
      <button class="m-save-btn" id="mSaveBtn">ì—…ë°ì´íŠ¸ ì™„ë£Œ</button>
      <button onclick="closeModal('mModal')" style="width:100%; margin-top:15px; border:none; background:none; color:#94a3b8; cursor:pointer; font-weight:bold;">ì·¨ì†Œí•˜ê¸°</button>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // â”€â”€ ì™¸ë¶€ GAS Web App URL ì„¤ì • â”€â”€
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzkWjkEd1ZWQPCDSq7YeWllYhTQo5OK010xb24j8i4Cag6NNQjtj0vx7oHClcaFbBk/exec';
    const ITEMS = ['WTI', 'Styrene', 'Acrylonitrile', 'Butadiene', 'BPA', 'MMA'];
    const UNITS = { 'WTI': '$/bbl', 'Styrene': '$/MT', 'Acrylonitrile': '$/MT', 'Butadiene': '$/MT', 'BPA': '$/MT', 'MMA': '$/MT' };
    let currentData = null;
    let chartType = 'LineChart';

    google.charts.load('current', {packages: ['corechart']});
    window.onload = init;

    // â”€â”€ ê³µí†µ í†µì‹  í•¨ìˆ˜ (GitHub -> GAS) â”€â”€
    async function callGAS(func, params) {
      try {
        const url = `${GAS_URL}?func=${func}&params=${encodeURIComponent(JSON.stringify(params))}`;
        const response = await fetch(url);
        return await response.json();
      } catch (e) {
        console.error("GAS í†µì‹  ì—ëŸ¬:", e);
        return { success: false };
      }
    }

    function init() {
      const curWeek = getCurrentISOWeek();
      const sel = document.getElementById('weekSelector');
      let opt = "";
      for (let y = 2033; y >= 2026; y--) {
        for (let w = 52; w >= 1; w--) {
          let ws = (w < 10) ? "0" + w : w;
          let val = `${y}-W${ws}`;
          opt += `<option value="${val}">${val}</option>`;
        }
      }
      sel.innerHTML = opt;
      
      callGAS('getWeekList', {}).then(res => {
        if(res.weeks && res.weeks.indexOf(curWeek) !== -1) { sel.value = curWeek; loadData(curWeek); }
        else if(res.weeks && res.weeks.length > 0) { sel.value = res.weeks[0]; loadData(res.weeks[0]); }
      });
    }

    function getCurrentISOWeek() {
      const d = new Date(); d.setHours(0,0,0,0);
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      const year = d.getFullYear();
      const week = Math.ceil((((d - new Date(year, 0, 1)) / 86400000) + 1) / 7);
      return year + "-W" + (week < 10 ? '0' + week : week);
    }

    async function loadData(week) {
      document.getElementById('displayWeek').innerText = "Week: " + week;
      const res = await callGAS('getWeekData', week);
      if(res.success) { currentData = res.data; render(res.data); }
    }

    function render(data) {
      const list = document.getElementById('mainRows');
      list.innerHTML = ITEMS.map(name => {
        const i = data.items[name];
        const diff = parseFloat(i.change_abs);
        const colorCls = diff > 0 ? 'up-bg' : (diff < 0 ? 'down-bg' : 'flat-bg');
        const arrow = diff > 0 ? 'â–²' : (diff < 0 ? 'â–¼' : '-');
        const isWTI = (name === 'WTI');
        
        let actionContent = isWTI ? `
          <div style="display:flex; gap:4px; margin-bottom:5px;">
            <button class="edit-btn" onclick="setChart('LineChart')">Line</button>
            <button class="edit-btn" onclick="setChart('AreaChart')">Area</button>
            <button class="edit-btn" onclick="setChart('ColumnChart')">Bar</button>
          </div>
          <div class="chart-area">
            <table class="wti-mini-table" id="wti_list_view"></table>
            <div id="wti_chart_div"></div>
          </div>
          <button class="edit-btn" onclick="openWtiEdit()">6ê±°ë˜ì¼ í†µí•© ìˆ˜ì •</button>
        ` : `<button class="edit-btn" onclick="openSingleEdit('${name}')">ìˆ˜ì •</button>`;

        return `
          <div class="item-row">
            <div class="name-box">${name}</div>
            <div class="price-col">
              <span class="p-main">${i.price.toLocaleString()}<small class="p-unit">${UNITS[name]}</small></span>
              <div class="change-badge ${colorCls}">${arrow} ${Math.abs(diff).toFixed(1)} (${i.change_rate}%)</div>
            </div>
            <div class="comm-col">${i.commentary || 'ë¶„ì„ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'}</div>
            <div class="action-col">${actionContent}</div>
          </div>
        `;
      }).join('');
      google.charts.setOnLoadCallback(drawWti);
    }

    function setChart(t) { chartType = t; drawWti(); }

    async function drawWti() {
      const history = await callGAS('getWtiHistory', {});
      if(!history || !history.length) return;
      const last6 = history.slice(-6);
      document.getElementById('wti_list_view').innerHTML = last6.map(h => `<tr><td>${h.label}</td><td style="color:black">${h.price}</td></tr>`).join('');
      
      const dt = new google.visualization.DataTable();
      dt.addColumn('string', 'ë‚ ì§œ'); dt.addColumn('number', 'ê°€ê²©'); dt.addColumn({type: 'string', role: 'annotation'});
      last6.forEach(h => dt.addRow([h.label, h.price, h.price.toString()]));
      
      new google.visualization[chartType](document.getElementById('wti_chart_div')).draw(dt, {
        curveType: 'function', legend: 'none', colors: ['#000000'],
        chartArea: {width: '85%', height: '70%', top: 10, right: 10},
        annotations: { alwaysOutside: true, textStyle: { fontSize: 10, bold: true, color: '#000' } },
        vAxis: { gridlines: {color: 'transparent'}, textPosition: 'none' },
        hAxis: { textStyle: {fontSize: 9, color: '#94a3b8'} }
      });
    }

    function openSingleEdit(n) {
      const i = currentData.items[n];
      document.getElementById('mTitle').innerText = n + " ë¦¬í¬íŠ¸ ìˆ˜ì •";
      document.getElementById('mFields').innerHTML = `<input type="number" step="0.01" id="mP" class="m-input" value="${i.price}"><textarea id="mC" class="m-input" style="height:220px; font-weight:800;">${i.commentary}</textarea>`;
      document.getElementById('mSaveBtn').onclick = async () => {
        msg('ì €ì¥ ì¤‘...', 'var(--orange)');
        await callGAS('saveData', {week: currentData.week, item: n, price: document.getElementById('mP').value, commentary: document.getElementById('mC').value});
        msg('âœ“ ì™„ë£Œ', '#27ae60'); closeModal('mModal'); loadData(currentData.week);
      };
      document.getElementById('mModal').style.display = 'flex';
    }

    function openWtiEdit() {
      document.getElementById('mTitle').innerText = "WTI 6ê±°ë˜ì¼ í†µí•© ìˆ˜ì •";
      let h = `<div style="padding:12px; background:#f8fafc; border-radius:12px; margin-bottom:15px;"><strong>ì˜ì—…ì¼ ê¸°ì¤€ 6ì¼ ì—­ì‚°</strong>`;
      let dates = []; let tempD = new Date();
      while(dates.length < 6) { if(tempD.getDay() !== 0 && tempD.getDay() !== 6) dates.push(new Date(tempD).toISOString().split('T')[0]); tempD.setDate(tempD.getDate() - 1); }
      dates.reverse();
      dates.forEach((d, i) => h += `<div style="display:flex; gap:6px; margin-top:8px;"><input type="date" id="wd_${i}" class="m-input" value="${d}" style="flex:1.2; margin:0;"><input type="number" step="0.01" id="wp_${i}" class="m-input" placeholder="ê°€ê²©" style="flex:1; margin:0;"></div>`);
      h += `</div><input type="number" id="wP" class="m-input" value="${currentData.items['WTI'].price}"><textarea id="wC" class="m-input" style="height:120px; font-weight:800;">${currentData.items['WTI'].commentary}</textarea>`;
      document.getElementById('mFields').innerHTML = h;
      document.getElementById('mSaveBtn').onclick = async () => {
        msg('ë°ì´í„° ì „ì†¡ ì¤‘...', 'var(--orange)');
        let es = []; for(let i=0; i<6; i++) { let p = document.getElementById("wp_"+i).value; if(p) es.push({date: document.getElementById("wd_"+i).value, price: parseFloat(p)}); }
        await callGAS('saveDailyWtiBulk', es);
        await callGAS('saveData', {week: currentData.week, item: 'WTI', price: document.getElementById('wP').value, commentary: document.getElementById('wC').value});
        msg('âœ“ ì™„ë£Œ', '#27ae60'); closeModal('mModal'); loadData(currentData.week);
      };
      document.getElementById('mModal').style.display = 'flex';
    }

    function openNewReport() {
      const cur = getCurrentISOWeek();
      document.getElementById('mTitle').innerText = "ì‹ ê·œ ë¦¬í¬íŠ¸ ìƒì„±";
      let h = `<select id="nw" class="m-input" style="font-weight:900;"><option value="${cur}">${cur}</option></select>`;
      ITEMS.forEach(n => h += `<div style="font-weight:800; margin-top:10px; color:#666;">${n}</div><div style="display:flex; gap:10px;"><input type="number" id="np_${n}" class="m-input" placeholder="ê°€ê²©" style="flex:1;"><input type="text" id="nc_${n}" class="m-input" placeholder="ë¶„ì„ ì½”ë©˜íŠ¸" style="flex:2.5;"></div>`);
      document.getElementById('mFields').innerHTML = h;
      document.getElementById('mSaveBtn').onclick = async () => {
        msg('ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...', 'var(--orange)');
        const w = document.getElementById('nw').value;
        for(let n of ITEMS) {
          await callGAS('saveData', {week: w, item: n, price: document.getElementById('np_'+n).value, commentary: document.getElementById('nc_'+n).value});
        }
        msg('âœ“ ìƒì„± ì„±ê³µ', '#27ae60'); closeModal('mModal'); init();
      };
      document.getElementById('mModal').style.display = 'flex';
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function msg(m, bg) { const t = document.getElementById('toast'); t.innerText = m; t.style.background = bg; t.className = 'show'; setTimeout(()=>t.className='', 2500); }

    function takeCapture() {
      const area = document.getElementById('captureArea');
      area.classList.add('capture-mode');
      msg('ğŸ–¼ï¸ ì´ë¯¸ì§€ ìƒì„± ì¤‘...', 'var(--orange)');
      html2canvas(area, { scale: 2.5, useCORS: true, width: 1800 }).then(canvas => {
        const a = document.createElement('a'); a.download = `LAM_Brief_${currentData.week}.png`; a.href = canvas.toDataURL(); a.click();
        area.classList.remove('capture-mode');
        msg('âœ“ ì €ì¥ ì™„ë£Œ', '#27ae60');
      });
    }

    function copyToKakao() {
      let t = `[LAM Weekly Brief - ${currentData.week}]\n\n`;
      ITEMS.forEach(n => { const i = currentData.items[n]; t += `${n}: ${i.price} (${i.change_abs > 0 ? 'â–²':'â–¼'}${Math.abs(i.change_abs).toFixed(1)})\n- ${i.commentary}\n\n`; });
      navigator.clipboard.writeText(t).then(() => msg('âœ“ í´ë¦½ë³´ë“œ ë³µì‚¬ë¨', '#27ae60'));
    }
  </script>
</body>
</html>
