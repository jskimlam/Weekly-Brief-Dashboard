<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>LAM Weekly Chemical Brief</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* â”€â”€ ìŠ¤íƒ€ì¼ ì „ì—­ ë³€ìˆ˜ ì„¤ì • â”€â”€ */
    :root {
      --main-orange: #FF8C00;
      --border-color: #d1d8e0;
      --card-bg: #ffffff;
      --up-red: #e74c3c;
      --down-blue: #3498db;
      --none-black: #2d3436; 
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background-color: #f0f2f5; color: var(--none-black); font-family: 'Pretendard', sans-serif; line-height: 1.6; }

    /* â”€â”€ í—¤ë” ë ˆì´ì•„ì›ƒ â”€â”€ */
    .header { display: flex; align-items: center; justify-content: space-between; padding: 15px 25px; background: #ffffff; border-bottom: 4px solid var(--main-orange); position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .lam-badge { background: var(--main-orange); color: #fff; font-weight: 900; font-size: 24px; padding: 5px 15px; border-radius: 8px; }
    .title-text { font-size: 22px; font-weight: 800; margin-left: 10px; }
    .title-text span { color: #ff3e3e; }

    /* â”€â”€ ë²„íŠ¼ ë° ìƒë‹¨ ì»¨íŠ¸ë¡¤ â”€â”€ */
    .btn-group { display: flex; gap: 6px; align-items: center; overflow-x: auto; }
    .btn { padding: 10px 14px; border-radius: 6px; font-weight: 700; cursor: pointer; border: none; font-size: 13px; white-space: nowrap; transition: 0.2s; }
    .btn-copy { background: #2ecc71; color: white; }
    .btn-save { background: #3498db; color: white; }
    .btn-new { background: #ff3e3e; color: white; }
    .btn-refresh { background: #636e72; color: white; }

    /* â”€â”€ ë¦¬í¬íŠ¸ ì¹´ë“œ ë””ìì¸ â”€â”€ */
    .main-content { padding: 20px; max-width: 1400px; margin: 0 auto; }
    .report-container { background: white; padding: 25px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .item-card { background: var(--card-bg); border: 2.5px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 18px; display: grid; grid-template-columns: 180px 140px 150px 1fr 80px; align-items: center; gap: 20px; box-shadow: 0 3px 8px rgba(0,0,0,0.05); }
    .item-name { font-size: 24px; font-weight: 900; color: var(--none-black); background: #fff5e6; padding: 12px; border-radius: 8px; text-align: center; border: 1.5px solid #ffe0b2; }
    .item-price { font-size: 24px; font-weight: 900; text-align: center; line-height: 1.2; }
    .item-price small { font-size: 13px; color: #888; display: block; font-weight: 500; }
    .price-up { color: var(--up-red) !important; }
    .price-down { color: var(--down-blue) !important; }
    .price-none { color: var(--none-black) !important; }

    /* â”€â”€ ëª¨ë°”ì¼ ë° ëª¨ë‹¬ ë ˆì´ì•„ì›ƒ â”€â”€ */
    @media (max-width: 767px) { .item-card:not(.export-mode .item-card) { grid-template-columns: 1fr 1fr; grid-template-areas: "name price" "change change" "comm comm" "edit edit"; gap: 15px; padding: 20px; } .item-name { grid-area: name; } .item-price { grid-area: price; } .btn-edit { grid-area: edit; } }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; padding: 15px; }
    .modal-overlay.active { display: flex; }
    .modal-box { background: white; width: 100%; max-width: 850px; border-radius: 15px; padding: 30px; max-height: 90vh; overflow-y: auto; }
    .smart-parser { background: #fff9f0; border: 2px dashed var(--main-orange); padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    .smart-textarea { width: 100%; height: 100px; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin-top: 10px; }
    .modal-grid { display: grid; grid-template-columns: 120px 120px 1fr; gap: 10px; margin-top: 10px; align-items: center; }
    .modal-label { background: var(--main-orange); color: white; padding: 8px; border-radius: 4px; text-align: center; font-weight: 700; }
    .modal-input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100%; }
    .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 30px; border-radius: 30px; display: none; z-index: 5000; }
  </style>
</head>
<body>

<div class="header"> <div style="display:flex; align-items:center;">
    <div class="lam-badge">LAM</div>
    <div class="title-text">Weekly <span>Market</span> Brief</div>
  </div>
  <div class="btn-group">
    <button class="btn btn-refresh" onclick="refreshData()">â†»</button>
    <button class="btn btn-copy" onclick="copyToClipboard()">ğŸ“‹ ì¹´í†¡ë³µì‚¬</button>
    <button class="btn btn-save" onclick="saveAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€</button>
    <select id="weekSelector" onchange="loadWeekData(this.value)" class="btn" style="background:white; border:2px solid var(--main-orange); color:var(--main-orange);"></select>
    <button class="btn btn-new" onclick="openModal()">+ NEW</button>
  </div>
</div>

<div class="main-content"> <div id="captureArea" class="report-container">
    <div id="reportContent"><h3>ë°ì´í„° ë¡œë”© ì¤‘...</h3></div>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay"> <div class="modal-box">
    <h2 id="modalTitle" style="color:var(--main-orange); margin-bottom:15px;">ğŸ“Š ë¦¬í¬íŠ¸ ì‘ì„±</h2>
    <div id="smartParserSection" class="smart-parser">
      <strong>âœ¨ ìŠ¤ë§ˆíŠ¸ íŒŒì‹± (ë¶™ì—¬ë„£ê¸°)</strong>
      <textarea id="smartInput" class="smart-textarea" placeholder="WTI&#10;1.ê°€ê²©&#10;78.5..." oninput="parseSmartText()"></textarea>
    </div>
    <div style="margin-bottom:20px; display:flex; align-items:center; gap:10px;">
      <span style="font-weight:800;">í•´ë‹¹ ì£¼ì°¨:</span>
      <input type="text" id="modalWeek" class="modal-input" style="width:150px;" placeholder="YYYY-Wnn ì˜ˆ: 2026-W08">
    </div>
    <div id="modalItemRows"></div>
    <div style="margin-top:25px; text-align:right;">
      <button class="btn" onclick="closeModal()" style="background:#eee; color:#333;">ë‹«ê¸°</button>
      <button id="modalSubmitBtn" class="btn btn-new">ì €ì¥í•˜ê¸°</button>
    </div>
  </div>
</div>

<div class="toast" id="toastMsg"></div>

<script>
  // GAS URL ë° ê¸°ë³¸ ë³€ìˆ˜ ì„¤ì •
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxTZjLHMxfRCAvM1FietPXm7XVvLm-BeaD8Yyue2BBujzyyhDycj3Hm9arp5SsqQqOf/exec';
  const ITEMS = ['WTI', 'Styrene', 'Acrylonitrile', 'Butadiene', 'BPA', 'MMA'];
  const UNITS = {'WTI':'$/bbl','Styrene':'$/MT','Acrylonitrile':'$/MT','Butadiene':'$/MT','BPA':'$/MT','MMA':'$/MT'};
  let currentWeekData = null;

  document.addEventListener('DOMContentLoaded', () => { buildModalRows(); loadWeekList(); });

  async function callGAS(payload) { // ì„œë²„ í†µì‹  í•¨ìˆ˜
    try {
      const res = await fetch(GAS_URL + '?data=' + encodeURIComponent(JSON.stringify(payload)), { method: 'GET', redirect: 'follow' });
      return await res.json();
    } catch (e) { showToast('âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨'); return {success:false}; }
  }

  async function loadWeekList() { // ì£¼ì°¨ ëª©ë¡ ë¡œë“œ
    const res = await callGAS({action:'getWeekList'});
    if(res.success && res.weeks.length > 0) {
      const sel = document.getElementById('weekSelector');
      sel.innerHTML = res.weeks.map(w => `<option value="${w}">${w}</option>`).join('');
      loadWeekData(res.weeks[0]);
    }
  }

  async function loadWeekData(week) { // ë°ì´í„° ë¡œë“œ
    const res = await callGAS({action:'getData', week: week});
    if(res.success) { currentWeekData = res; renderMainUI(res); }
  }

  function renderMainUI(data) { // UI ë Œë”ë§
    let html = `<div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:3px solid var(--main-orange); padding-bottom:10px;"><h2>Weekly Report</h2><span>Week: ${data.week}</span></div>`;
    ITEMS.forEach(name => {
      const d = data.items[name] || {};
      const abs = parseFloat(d.change_abs);
      const isNum = !isNaN(abs);
      const cls = isNum ? (abs > 0 ? 'up' : (abs < 0 ? 'down' : 'none')) : 'none';
      html += `<div class="item-card"><div class="item-name">${name}</div><div class="item-price price-${cls}">${d.price || '-'}<small>(${UNITS[name]})</small></div><div class="item-change change-${cls}">${isNum ? (abs > 0 ? 'â–²' : 'â–¼') + Math.abs(abs).toFixed(1) : '-'}</div><div class="item-comm">${d.commentary || '-'}</div><button class="btn-edit" onclick="quickEdit('${name}','${d.price}','${d.commentary}')">ìˆ˜ì •</button></div>`;
    });
    document.getElementById('reportContent').innerHTML = html;
  }

  function quickEdit(name, price, comm) { // ê°œë³„ ìˆ˜ì • ëª¨ë‹¬ ì„¤ì •
    document.getElementById('modalTitle').textContent = `âœï¸ ${name} ìˆ˜ì •`;
    document.getElementById('smartParserSection').style.display = 'none';
    document.getElementById('modalWeek').value = currentWeekData.week;
    document.getElementById('modalItemRows').innerHTML = `<div class="modal-grid"><div class="modal-label">${name}</div><input type="number" id="m_p_${name}" class="modal-input" value="${price}"><input type="text" id="m_c_${name}" class="modal-input" value="${comm}"></div>`;
    document.getElementById('modalSubmitBtn').onclick = () => processUpdate(name);
    document.getElementById('modalOverlay').classList.add('active');
  }

  async function processUpdate(name) { // ìˆ˜ì •ì‚¬í•­ ì„œë²„ ì „ì†¡
    const p = document.getElementById('m_p_'+name).value;
    const c = document.getElementById('m_c_'+name).value;
    showToast('ğŸ’¾ ì €ì¥ ì¤‘...');
    const res = await callGAS({action:'updateItemData', week:currentWeekData.week, item:name, price:p, commentary:c});
    if(res.success) { closeModal(); loadWeekData(currentWeekData.week); showToast('âœ… ìˆ˜ì • ì™„ë£Œ'); }
  }

  function openModal() { // ì‹ ê·œ ì‘ì„± ëª¨ë‹¬ ì—´ê¸°
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const wk = Math.ceil(((now - start) / 86400000 + start.getDay() + 1) / 7);
    document.getElementById('modalTitle').textContent = 'ğŸ“Š ë¦¬í¬íŠ¸ ì‘ì„±';
    document.getElementById('smartParserSection').style.display = 'block';
    document.getElementById('modalWeek').value = now.getFullYear() + '-W' + String(wk).padStart(2,'0');
    buildModalRows();
    document.getElementById('modalSubmitBtn').onclick = saveEntry;
    document.getElementById('modalOverlay').classList.add('active');
  }

  async function saveEntry() { // ì „ì²´ ì €ì¥
    const week = document.getElementById('modalWeek').value;
    const items = {};
    ITEMS.forEach(n => { items[n] = { price: document.getElementById('modal_price_'+n).value, commentary: document.getElementById('modal_comm_'+n).value }; });
    showToast('ğŸ’¾ ì €ì¥ ì¤‘...');
    const res = await callGAS({action:'saveEntry', data: {week, items}});
    if(res.success) { closeModal(); loadWeekList(); showToast('âœ… ì €ì¥ ì™„ë£Œ'); }
  }

  function buildModalRows() { // ëª¨ë‹¬ í–‰ ìƒì„±
    document.getElementById('modalItemRows').innerHTML = ITEMS.map(n => `<div class="modal-grid"><div class="modal-label">${n}</div><input type="number" id="modal_price_${n}" class="modal-input" placeholder="ê°€ê²©"><input type="text" id="modal_comm_${n}" class="modal-input" placeholder="ì½”ë©˜í„°ë¦¬"></div>`).join('');
  }

  function parseSmartText() { // ìŠ¤ë§ˆíŠ¸ íŒŒì‹± ë¡œì§
    const text = document.getElementById('smartInput').value;
    const itemRegex = new RegExp(`(${ITEMS.join('|')})`, 'gi');
    let sections = text.split(itemRegex);
    for (let i = 1; i < sections.length; i += 2) {
      const name = sections[i].toUpperCase();
      const content = sections[i+1];
      const pMatch = content.match(/1\.ê°€ê²©\s*[\r\n]+([\d.,]+)/i) || content.match(/(\d+(\.\d+)?)/);
      const cMatch = content.match(/2\.ì½”ë©˜í„°ë¦¬\s*[\r\n]+([\s\S]+?)(?=\n\d\.|$)/i);
      if(pMatch) document.getElementById('modal_price_'+name).value = pMatch[1].replace(/,/g,'');
      if(cMatch) document.getElementById('modal_comm_'+name).value = cMatch[1].trim();
    }
  }

  function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }
  function showToast(m) { const t = document.getElementById('toastMsg'); t.textContent = m; t.style.display = 'block'; setTimeout(()=>t.style.display='none',3000); }
  function refreshData() { loadWeekList(); }
</script>
</body>
</html>
