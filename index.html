<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>LAM Weekly Chemical Brief</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* â”€â”€ ë””ìì¸ í…Œë§ˆ â”€â”€ */
    :root {
      --main-orange: #FF8C00;
      --border-color: #d1d8e0;
      --up-red: #e74c3c;
      --down-blue: #3498db;
      --none-black: #2d3436; 
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background-color: #f0f2f5;
      color: var(--none-black);
      font-family: 'Pretendard', -apple-system, system-ui, sans-serif;
    }

    /* â”€â”€ ìƒë‹¨ í—¤ë” â”€â”€ */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 15px 25px; background: #ffffff; border-bottom: 4px solid var(--main-orange);
      position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .lam-badge {
      background: var(--main-orange); color: #fff; font-weight: 900;
      font-size: 24px; padding: 5px 15px; border-radius: 8px;
    }
    .btn { padding: 10px 14px; border-radius: 6px; font-weight: 700; cursor: pointer; border: none; font-size: 13px; transition: 0.2s; white-space: nowrap; }
    .btn-copy { background: #2ecc71; color: white; }
    .btn-save { background: #3498db; color: white; }
    .btn-new { background: #ff3e3e; color: white; }
    .btn-refresh { background: #636e72; color: white; }

    /* â”€â”€ ë¦¬í¬íŠ¸ ë³¸ë¬¸ â”€â”€ */
    .main-content { padding: 20px; max-width: 1400px; margin: 0 auto; }
    .report-container { 
      background: white; padding: 25px; border-radius: 12px; 
      border: 2px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    /* â”€â”€ í’ˆëª© ì¹´ë“œ (PC ê³ ì • ë ˆì´ì•„ì›ƒ) â”€â”€ */
    .item-card {
      background: white; border: 2.5px solid var(--border-color);
      border-radius: 12px; padding: 20px; margin-bottom: 18px;
      display: grid; grid-template-columns: 180px 140px 150px 1fr 80px;
      align-items: center; gap: 20px;
    }

    /* í’ˆëª©ëª… ìŠ¤íƒ€ì¼ (ê²€ì •ìƒ‰ êµµê²Œ) */
    .item-name {
      font-size: 24px; font-weight: 900; color: var(--none-black); 
      background: #fff5e6; padding: 12px; border-radius: 8px; text-align: center;
      border: 1.5px solid #ffe0b2;
    }
    
    /* í˜„ì¬ ê°€ê²© (ìƒìŠ¹-ë¹¨ê°•, í•˜ë½-íŒŒë‘ ê°•ì¡°) */
    .item-price { font-size: 24px; font-weight: 900; text-align: center; line-height: 1.2; position: relative; }
    .item-price small { font-size: 13px; color: #888; display: block; font-weight: 500; }
    
    .price-up { color: var(--up-red) !important; }
    .price-down { color: var(--down-blue) !important; }
    .price-none { color: var(--none-black) !important; }

    .item-change { font-size: 17px; font-weight: 700; text-align: center; padding: 10px; border-radius: 8px; }
    .change-up { color: var(--up-red); background: #fdedec; border: 1px solid #fadbd8; }
    .change-down { color: var(--down-blue); background: #ebf5fb; border: 1px solid #d6eaf8; }
    .change-none { color: #7f8c8d; background: #f4f6f7; border: 1px solid #e5e8e8; }

    /* ì½”ë©˜í„°ë¦¬ (ì„¸ë¡œì„  ê°•ì¡°) */
    .item-comm { 
      font-size: 18px; color: #1e272e; border-left: 6px solid var(--main-orange); 
      padding: 5px 20px; font-weight: 700; word-break: keep-all;
    }
    .btn-edit-small { background: #f1f2f6; border: 1px solid #ddd; padding: 8px; border-radius: 4px; font-size: 12px; cursor: pointer; }

    /* â˜… WTI ê·¸ë˜í”„ ì˜ì—­ (WTI ê°€ê²© ì•„ë˜ ìë™ ì‚½ì…) â˜… */
    .wti-chart-area { width: 100%; height: 75px; margin-top: 10px; background: #fcfcfc; border-radius: 4px; border: 1px solid #eee; }

    /* â”€â”€ ëª¨ë°”ì¼ ê°€ì‹œì„± (ê°¤ëŸ­ì‹œ/í´ë“œ ìµœì í™”) â”€â”€ */
    @media (max-width: 767px) {
      .item-card:not(.export-mode .item-card) {
        grid-template-columns: 1fr 1fr;
        grid-template-areas: "name price" "change change" "comm comm" "edit edit";
        gap: 15px; padding: 20px;
      }
      .item-name { grid-area: name; font-size: 22px; }
      .item-price { grid-area: price; text-align: right; font-size: 26px; }
      .item-change { grid-area: change; width: 100%; font-size: 17px; }
      .item-comm { grid-area: comm; border-left: none; border-top: 4px solid var(--main-orange); padding: 15px 0 0 0; margin-top: 5px; font-size: 17px; }
      .btn-edit-small { grid-area: edit; width: 100%; padding: 12px; font-size: 14px; }
    }

    /* â”€â”€ ì´ë¯¸ì§€ ì €ì¥ ì‹œ PC ë ˆì´ì•„ì›ƒ ê³ ì • (Export Mode) â”€â”€ */
    .export-mode .report-container { width: 1200px !important; min-width: 1200px !important; }
    .export-mode .item-card {
      grid-template-columns: 180px 140px 150px 1fr 80px !important;
      grid-template-areas: none !important;
      display: grid !important;
    }
    .export-mode .item-comm { border-left: 6px solid var(--main-orange) !important; border-top: none !important; padding: 5px 20px !important; }
    .export-mode .btn-edit-small, .export-mode .wti-chart-area { display: none !important; }

    /* â”€â”€ í†µí•© ëª¨ë‹¬ ì°½ â”€â”€ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; padding: 15px; }
    .modal-overlay.active { display: flex; }
    .modal-box { background: white; width: 100%; max-width: 850px; border-radius: 15px; padding: 30px; max-height: 90vh; overflow-y: auto; }
    .smart-parser { background: #fff9f0; border: 2px dashed var(--main-orange); padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    
    /* ì¼ë³„ ê°€ê²© ì…ë ¥ íŒŒë€ìƒ‰ ì„¹ì…˜ */
    .daily-input-box { background: #f0f7ff; border: 1.5px solid #3498db; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    .modal-grid { display: grid; grid-template-columns: 120px 120px 1fr; gap: 10px; margin-top: 10px; align-items: center; }
    .modal-label { background: var(--main-orange); color: white; padding: 8px; border-radius: 4px; text-align: center; font-weight: 700; }
    .modal-input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100%; }

    .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 30px; border-radius: 30px; display: none; z-index: 5000; font-weight: 700; }
  </style>
</head>
<body>

<div class="header">
  <div style="display:flex; align-items:center;">
    <div class="lam-badge">LAM</div>
    <div class="title-text">Weekly <span>Market</span> Brief</div>
  </div>
  <div class="btn-group">
    <button class="btn btn-refresh" onclick="refreshData()">â†»</button>
    <button class="btn btn-copy" onclick="copyToClipboard()">ğŸ“‹ ì¹´í†¡ë³µì‚¬</button>
    <button class="btn btn-save" onclick="saveAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€</button>
    <button class="btn btn-save" style="background:#17a2b8;" onclick="saveAsPDF()">ğŸ“„ PDF</button>
    <select id="weekSelector" onchange="loadWeekData(this.value)" class="btn" style="background:white; border:2px solid var(--main-orange); color:var(--main-orange);"></select>
    <button class="btn btn-new" onclick="openModal()">+ NEW</button>
  </div>
</div>

<div class="main-content">
  <div id="captureArea" class="report-container">
    <div id="reportContent">
      <h3 style="text-align:center; padding:50px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h3>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal-box">
    <h2 id="modalTitle" style="color:var(--main-orange); margin-bottom:15px; font-size:22px;">ğŸ“Š ë¦¬í¬íŠ¸ ì‘ì„±</h2>
    
    <div id="smartParserSection" class="smart-parser">
      <strong>âœ¨ ìŠ¤ë§ˆíŠ¸ íŒŒì‹± (ë¶™ì—¬ë„£ê¸°)</strong>
      <textarea id="smartInput" style="width:100%; height:100px; margin-top:10px; padding:10px; border:1px solid #ddd; border-radius:5px;" placeholder="WTI 78.5..." oninput="parseSmartText()"></textarea>
    </div>

    <div id="dailyWtiSection" class="daily-input-box">
      <strong style="display:block; margin-bottom:10px;">ğŸ“‰ WTI ì´ë²ˆ ì£¼ ì¼ë³„ ê°€ê²© (ì›”~ê¸ˆ)</strong>
      <div style="display:flex; gap:5px; flex-wrap:wrap;">
        <input type="number" id="wti_mon" class="modal-input" style="width:18%;" placeholder="ì›”">
        <input type="number" id="wti_tue" class="modal-input" style="width:18%;" placeholder="í™”">
        <input type="number" id="wti_wed" class="modal-input" style="width:18%;" placeholder="ìˆ˜">
        <input type="number" id="wti_thu" class="modal-input" style="width:18%;" placeholder="ëª©">
        <input type="number" id="wti_fri" class="modal-input" style="width:18%;" placeholder="ê¸ˆ">
      </div>
      <small style="color:#2980b9; margin-top:5px; display:block;">* ì—¬ê¸°ì— ì…ë ¥í•œ ê°’ì´ ê·¸ë˜í”„ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.</small>
    </div>

    <div style="margin-bottom:20px; display:flex; align-items:center; gap:10px;">
      <span style="font-weight:800;">ëŒ€ìƒ ì£¼ì°¨:</span>
      <input type="text" id="modalWeek" class="modal-input" style="width:150px;" readonly>
    </div>

    <div id="modalItemRows"></div>

    <div style="margin-top:25px; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
      <button class="btn" onclick="closeModal()" style="background:#eee; color:#333;">ë‹«ê¸°</button>
      <button id="modalSubmitBtn" class="btn btn-new">ë°ì´í„° ì €ì¥í•˜ê¸°</button>
    </div>
  </div>
</div>

<div class="toast" id="toastMsg"></div>

<script>
  // â˜… ë³¸ì¸ì˜ GAS ì›¹ì•± URLë¡œ êµì²´ â˜…
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxTZjLHMxfRCAvM1FietPXm7XVvLm-BeaD8Yyue2BBujzyyhDycj3Hm9arp5SsqQqOf/exec';
  const ITEMS = ['WTI', 'Styrene', 'Acrylonitrile', 'Butadiene', 'BPA', 'MMA'];
  const UNITS = {'WTI':'$/bbl','Styrene':'$/MT','Acrylonitrile':'$/MT','Butadiene':'$/MT','BPA':'$/MT','MMA':'$/MT'};
  let currentWeekData = null;

  // êµ¬ê¸€ ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—”ì§„ ì´ˆê¸°í™”
  google.charts.load('current', {packages:['corechart']});

  document.addEventListener('DOMContentLoaded', () => { 
    buildModalRows(); 
    loadWeekList(); 
  });

  async function callGAS(payload) {
    try {
      const res = await fetch(GAS_URL + '?data=' + encodeURIComponent(JSON.stringify(payload)), { method: 'GET', redirect: 'follow' });
      return await res.json();
    } catch (e) { return {success:false}; }
  }

  async function loadWeekList() {
    const res = await callGAS({action:'getWeekList'});
    if(res.success && res.weeks.length > 0) {
      document.getElementById('weekSelector').innerHTML = res.weeks.map(w => `<option value="${w}">${w}</option>`).join('');
      loadWeekData(res.weeks[0]);
    }
  }

  async function loadWeekData(week) {
    const res = await callGAS({action:'getData', week: week});
    if(res.success) { currentWeekData = res; renderMainUI(res); }
  }

  function renderMainUI(data) {
    let html = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; border-bottom:3px solid var(--main-orange); padding-bottom:10px;"><h2 style="font-size:24px;">Weekly Chemical Market Report</h2><span style="font-weight:700;">Week: ${data.week}</span></div>`;
    
    ITEMS.forEach(name => {
      const d = data.items[name] || {};
      const abs = parseFloat(d.change_abs);
      const isNum = !isNaN(abs);
      const statusCls = isNum ? (abs > 0 ? 'up' : (abs < 0 ? 'down' : 'none')) : 'none';
      const sign = isNum ? (abs > 0 ? 'â–²' : (abs < 0 ? 'â–¼' : '-')) : '-';
      
      html += `
        <div class="item-card">
          <div class="item-name">${name}</div>
          <div class="item-price price-${statusCls}">
            ${d.price || '-'}<small>(${UNITS[name]})</small>
            ${name === 'WTI' ? '<div id="wti_chart_container" class="wti-chart-area"></div>' : ''}
          </div>
          <div class="item-change change-${statusCls}">${sign} ${isNum ? Math.abs(abs).toFixed(1) : '-'}(${isNum ? d.change_pct.toFixed(1) : '0.0'}%)</div>
          <div class="item-comm">${d.commentary || 'ë¶„ì„ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'}</div>
          <button class="btn btn-edit-small" onclick="quickEdit('${name}', '${d.price || ''}', '${d.commentary || ''}')">ìˆ˜ì •</button>
        </div>
      `;
    });
    document.getElementById('reportContent').innerHTML = html;
    
    // ì°¨íŠ¸ ë™ê¸°í™” ë¡œì§: ë¡œë”© ì™„ë£Œ í™•ì¸ í›„ ì‹¤í–‰
    if (google.visualization) {
       drawWtiChart();
    } else {
       google.charts.setOnLoadCallback(drawWtiChart);
    }
  }

  /**
   * WTI ì¼ë³„ ê·¸ë˜í”„ ê·¸ë¦¬ê¸° (ë¶€ë“œëŸ¬ìš´ ê³¡ì„  ë° ëŠê¹€ ë°©ì§€)
   */
  async function drawWtiChart() {
    const res = await callGAS({action:'getDailyWti'});
    const target = document.getElementById('wti_chart_container');
    
    if(res.success && res.data.length > 0 && target) {
      const dataTable = new google.visualization.DataTable();
      dataTable.addColumn('string', 'Date');
      dataTable.addColumn('number', 'Price');
      res.data.forEach(d => dataTable.addRow([d.date, d.price]));
      
      const chart = new google.visualization.LineChart(target);
      chart.draw(dataTable, {
        curveType: 'function', // ë¶€ë“œëŸ¬ìš´ ì„ 
        legend: 'none',
        interpolateNulls: true, // ëŠê¸´ ë°ì´í„° ìë™ ì—°ê²°
        hAxis: { textPosition: 'none', gridlines: {color:'transparent'} },
        vAxis: { textPosition: 'none', gridlines: {color:'transparent'} },
        chartArea: {width:'100%', height:'85%'},
        colors: ['#FF8C00'],
        lineWidth: 3,
        animation: { startup: true, duration: 700, easing: 'out' }
      });
    }
  }

  // í†µí•© ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
  function quickEdit(name, oldPrice, oldComm) {
    document.getElementById('modalTitle').textContent = `âœï¸ [${name}] ë°ì´í„° í†µí•© ìˆ˜ì •`;
    document.getElementById('smartParserSection').style.display = 'none';
    document.getElementById('dailyWtiSection').style.display = 'none';
    document.getElementById('modalWeek').value = currentWeekData.week;
    
    document.getElementById('modalItemRows').innerHTML = `
      <div class="modal-grid">
        <div class="modal-label">${name}</div>
        <input type="number" step="0.01" id="modal_price_${name}" class="modal-input" value="${oldPrice}">
        <input type="text" id="modal_comm_${name}" class="modal-input" value="${oldComm}">
      </div>
    `;

    const btn = document.getElementById('modalSubmitBtn');
    btn.onclick = async () => {
      const p = document.getElementById('modal_price_'+name).value;
      const c = document.getElementById('modal_comm_'+name).value;
      const res = await callGAS({action:'updateItemData', week:currentWeekData.week, item:name, price:p, commentary:c});
      if(res.success) { closeModal(); loadWeekData(currentWeekData.week); showToast('âœ… ìˆ˜ì • ì™„ë£Œ'); }
    };
    btn.textContent = 'ì ìš©í•˜ê¸°';
    document.getElementById('modalOverlay').classList.add('active');
  }

  // ì´ë¯¸ì§€ ì €ì¥ (PC ë ˆì´ì•„ì›ƒ ê°•ì œ ë¶€ì—¬)
  async function saveAsImage() {
    const area = document.getElementById('captureArea');
    document.body.classList.add('export-mode'); 
    showToast('ğŸ–¼ï¸ ë¦¬í¬íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
    
    html2canvas(area, { scale: 2, useCORS: true, width: 1200, windowWidth: 1200 }).then(canvas => {
      const link = document.createElement('a');
      link.download = `LAM_Report_${currentWeekData.week}.png`;
      link.href = canvas.toDataURL();
      link.click();
      document.body.classList.remove('export-mode');
      showToast('âœ… ì´ë¯¸ì§€ ì €ì¥ ì„±ê³µ');
    });
  }

  function saveAsPDF() { 
    document.body.classList.add('export-mode');
    setTimeout(() => { window.print(); document.body.classList.remove('export-mode'); }, 500);
  }

  function parseSmartText() {
    const text = document.getElementById('smartInput').value;
    const itemRegex = new RegExp(`(${ITEMS.join('|')})`, 'gi');
    let sections = text.split(itemRegex);
    for (let i = 1; i < sections.length; i += 2) {
      const name = sections[i].toUpperCase(), content = sections[i+1];
      const pMatch = content.match(/(\d+(\.\d+)?)/);
      if(pMatch) document.getElementById('modal_price_'+name).value = pMatch[0];
    }
  }

  function copyToClipboard() {
    let text = `[LAM Weekly Brief - ${currentWeekData.week}]\n\n`;
    ITEMS.forEach(name => {
      const d = currentWeekData.items[name];
      const abs = parseFloat(d.change_abs) || 0;
      text += `${name}: ${d.price} (${abs > 0 ? 'â–²' : (abs < 0 ? 'â–¼' : '-')}${Math.abs(abs).toFixed(1)})\n- ${d.commentary || 'ë‚´ìš©ì—†ìŒ'}\n\n`;
    });
    navigator.clipboard.writeText(text.trim()).then(() => showToast('âœ… í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
  }

  function openModal() {
    document.getElementById('modalTitle').textContent = 'ğŸ“Š ìœ„í´ë¦¬ ë¦¬í¬íŠ¸ ì‘ì„±';
    document.getElementById('smartParserSection').style.display = 'block';
    document.getElementById('dailyWtiSection').style.display = 'block';
    
    const now = new Date(), start = new Date(now.getFullYear(), 0, 1);
    const wk = Math.ceil(((now - start) / 86400000 + start.getDay() + 1) / 7);
    document.getElementById('modalWeek').value = now.getFullYear() + '-W' + String(wk).padStart(2,'0');
    
    buildModalRows();
    clearModalInputs();
    
    document.getElementById('modalSubmitBtn').onclick = saveEntry;
    document.getElementById('modalSubmitBtn').textContent = 'ë°ì´í„° ì €ì¥í•˜ê¸°';
    document.getElementById('modalOverlay').classList.add('active');
  }

  function buildModalRows() {
    document.getElementById('modalItemRows').innerHTML = ITEMS.map(name => `
      <div class="modal-grid">
        <div class="modal-label">${name}</div>
        <input type="number" step="0.01" id="modal_price_${name}" class="modal-input" placeholder="ê°€ê²©">
        <input type="text" id="modal_comm_${name}" class="modal-input" placeholder="ë¶„ì„ ì½”ë©˜íŠ¸">
      </div>
    `).join('');
  }

  function clearModalInputs() { 
    document.getElementById('smartInput').value = '';
    ITEMS.forEach(n => { document.getElementById('modal_price_'+n).value = ''; document.getElementById('modal_comm_'+n).value = ''; }); 
    ['wti_mon','wti_tue','wti_wed','wti_thu','wti_fri'].forEach(id => document.getElementById(id).value = '');
  }

  function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

  async function saveEntry() {
    const week = document.getElementById('modalWeek').value, items = {};
    ITEMS.forEach(n => { items[n] = { price: document.getElementById('modal_price_'+n).value, commentary: document.getElementById('modal_comm_'+n).value }; });
    
    // ì¼ë³„ ë°ì´í„° ìˆ˜ì§‘ (ì›”~ê¸ˆ)
    const days = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'], ids = ['wti_mon','wti_tue','wti_wed','wti_thu','wti_fri'];
    const dailyWti = ids.map((id, idx) => ({ date: days[idx], price: document.getElementById(id).value }))
                        .filter(d => d.price !== "");

    showToast('ğŸ’¾ ì„œë²„ ì €ì¥ ë° ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì¤‘...');
    const res = await callGAS({action:'saveEntry', data: {week, items, dailyWti}});
    if(res.success) { 
       closeModal(); 
       loadWeekList(); 
       showToast('âœ… ì „ì²´ ì €ì¥ ì™„ë£Œ'); 
    }
  }

  function refreshData() { loadWeekList(); showToast('â†» ìµœì‹  ë°ì´í„°ë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤.'); }
  function showToast(msg) { const t = document.getElementById('toastMsg'); t.textContent = msg; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000); }
</script>
</body>
</html>
