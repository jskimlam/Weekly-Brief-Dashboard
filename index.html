<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LAM Weekly Chemical Brief</title>
  <style>
    /* â”€â”€ ì „ì—­ ë¦¬ì…‹ ë° ê¸°ë³¸ í°íŠ¸ ê°•í™” â”€â”€ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background-color: #f8f9fa;
      color: #333333;
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
      line-height: 1.6;
    }

    /* â”€â”€ í—¤ë” â”€â”€ */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 30px;
      background: #ffffff;
      border-bottom: 4px solid #FF8C00;
      position: sticky; top: 0; z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .title-box { display: flex; align-items: center; gap: 15px; }
    .lam-badge {
      background: #FF8C00; color: #fff;
      font-weight: 900; font-size: 26px;
      padding: 8px 20px; border-radius: 12px;
    }
    .title-text { font-size: 28px; font-weight: 800; }
    .title-text span { color: #FF0000; }

    /* â”€â”€ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ â”€â”€ */
    .btn {
      padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer;
      transition: all 0.2s; border: none; font-size: 15px;
    }
    .btn-copy { background: #28a745; color: white; margin-right: 5px; }
    .btn-new { background: #FF0000; color: white; }
    .btn-refresh { background: #6c757d; color: white; margin-right: 5px; }

    /* â”€â”€ ë©”ì¸ ì½˜í…ì¸  â”€â”€ */
    .main-content { padding: 30px; max-width: 1200px; margin: 0 auto; }

    /* â”€â”€ í’ˆëª© ì¹´ë“œ (ê°€ì‹œì„± ëŒ€í­ ê°•í™”) â”€â”€ */
    .item-card {
      background: #ffffff; border-radius: 15px; padding: 25px;
      margin-bottom: 20px; border: 1px solid #e9ecef;
      box-shadow: 0 4px 6px rgba(0,0,0,0.02);
      display: grid; grid-template-columns: 220px 180px 150px 1fr 100px;
      align-items: center; gap: 20px;
    }
    .item-name {
      font-size: 24px; font-weight: 900; color: #FF8C00;
      background: #fff8f0; padding: 10px; border-radius: 10px; text-align: center;
    }
    .item-price { font-size: 22px; font-weight: 800; text-align: center; }
    .item-price small { font-size: 14px; color: #888; display: block; }
    
    .item-change { font-size: 18px; font-weight: 700; text-align: center; padding: 8px; border-radius: 8px; }
    .change-up { color: #d63031; background: #fff5f5; }
    .change-down { color: #0984e3; background: #f0f7ff; }
    .change-none { color: #636e72; background: #f5f6fa; }

    .item-comm { font-size: 17px; color: #444; border-left: 3px solid #eee; padding-left: 15px; }
    .btn-edit-small { background: #f1f2f6; color: #555; padding: 5px 10px; font-size: 13px; }

    /* â”€â”€ ìŠ¤ë§ˆíŠ¸ íŒŒì„œ â”€â”€ */
    .smart-parser-box {
      background: #fff4e6; border: 2px dashed #FF8C00;
      padding: 20px; border-radius: 12px; margin-bottom: 25px;
    }
    .smart-textarea {
      width: 100%; height: 120px; margin-top: 10px; padding: 15px;
      border-radius: 8px; border: 1px solid #ffcc80; font-size: 15px;
    }

    /* â”€â”€ ëª¨ë‹¬ â”€â”€ */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-box {
      background: white; width: 900px; max-height: 90vh; padding: 40px;
      border-radius: 20px; overflow-y: auto; position: relative;
    }
    .modal-grid { display: grid; grid-template-columns: 140px 140px 1fr; gap: 10px; margin-top: 15px; }
    .modal-label { background: #FF8C00; color: white; padding: 10px; border-radius: 6px; text-align: center; font-weight: 700; }
    .modal-input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }

    /* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ */
    .toast {
      position: fixed; bottom: 30px; right: 30px; background: #333; color: #fff;
      padding: 15px 30px; border-radius: 50px; font-weight: 700; display: none; z-index: 10000;
    }

    @media (max-width: 1000px) {
      .item-card { grid-template-columns: 1fr 1fr; }
      .item-comm { grid-column: span 2; }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="title-box">
    <div class="lam-badge">LAM</div>
    <div class="title-text">Weekly <span>Chemical</span> Brief</div>
  </div>
  <div class="header-buttons">
    <button class="btn btn-refresh" onclick="refreshData()">â†» ìƒˆë¡œê³ ì¹¨</button>
    <button class="btn btn-copy" onclick="copyToClipboard()">ğŸ“‹ ì¹´í†¡ìš© ë³µì‚¬</button>
    <select class="week-selector" id="weekSelector" onchange="loadWeekData(this.value)" style="padding:10px; border-radius:8px; border:2px solid #FF8C00; font-weight:700;"></select>
    <button class="btn btn-new" onclick="openModal()">+ NEW ENTRY</button>
  </div>
</div>

<div class="main-content" id="mainContent"></div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal-box">
    <h2 style="margin-bottom:20px;">ğŸ“Š ì£¼ê°„ ë°ì´í„° ë¦¬í¬íŠ¸ ì‘ì„±</h2>
    
    <div class="smart-parser-box">
      <strong>âœ¨ ìŠ¤ë§ˆíŠ¸ íŒŒì‹± ì…ë ¥</strong> (í’ˆëª©ëª… ê¸°ì¬ í›„ 1.ê°€ê²© 2.ì½”ë©˜í„°ë¦¬ ì…ë ¥ ì‹œ ìë™ ë¶„ë¥˜)
      <textarea id="smartInput" class="smart-textarea" placeholder="WTI&#10;1.ê°€ê²©&#10;78.5&#10;2.ì½”ë©˜í„°ë¦¬&#10;ì›ìœ  ì¬ê³  ê°ì†Œ..." oninput="parseSmartText()"></textarea>
    </div>

    <div style="margin-bottom:20px;">
      <span style="font-weight:800; font-size:18px;">ì„ íƒ ì£¼ì°¨: </span>
      <input type="text" id="modalWeek" class="modal-input" style="width:150px;">
    </div>

    <div id="modalItemRows"></div>

    <div style="margin-top:30px; text-align:right;">
      <button class="btn" onclick="closeModal()" style="background:#eee;">ì·¨ì†Œ</button>
      <button class="btn btn-new" onclick="saveEntry()">DB ì €ì¥ ë° ì—…ë°ì´íŠ¸</button>
    </div>
  </div>
</div>

<div class="toast" id="toastMsg"></div>

<script>
  // GAS ë°°í¬ URL (ìˆ˜ì •ë¨)
  var GAS_URL = 'https://script.google.com/macros/s/AKfycbxTZjLHMxfRCAvM1FietPXm7XVvLm-BeaD8Yyue2BBujzyyhDycj3Hm9arp5SsqQqOf/exec';
  var ITEMS = ['WTI', 'Styrene', 'Acrylonitrile', 'Butadiene', 'BPA', 'MMA'];
  var UNITS = {'WTI':'$/bbl','Styrene':'$/MT','Acrylonitrile':'$/MT','Butadiene':'$/MT','BPA':'$/MT','MMA':'$/MT'};
  var currentWeekData = null;

  document.addEventListener('DOMContentLoaded', () => {
    buildModalRows();
    loadWeekList();
  });

  async function callGAS(payload) {
    try {
      const res = await fetch(GAS_URL + '?data=' + encodeURIComponent(JSON.stringify(payload)), { method: 'GET', redirect: 'follow' });
      return await res.json();
    } catch (e) { showToast('âš ï¸ ì—°ê²° ì˜¤ë¥˜'); return {success:false}; }
  }

  async function loadWeekList() {
    const res = await callGAS({action:'getWeekList'});
    if(res.success && res.weeks.length > 0) {
      const sel = document.getElementById('weekSelector');
      sel.innerHTML = res.weeks.map(w => `<option value="${w}">${w}</option>`).join('');
      loadWeekData(res.weeks[0]);
    }
  }

  async function loadWeekData(week) {
    document.getElementById('mainContent').innerHTML = '<h2>ë°ì´í„° ë¡œë“œ ì¤‘...</h2>';
    const res = await callGAS({action:'getData', week: week});
    if(res.success) {
      currentWeekData = res;
      renderMainUI(res);
    }
  }

  function renderMainUI(data) {
    let html = `<h2 style="margin-bottom:20px; color:#666;">ğŸ“… ë¦¬í¬íŠ¸ ì£¼ì°¨: ${data.week}</h2>`;
    ITEMS.forEach(name => {
      const d = data.items[name] || {};
      const abs = parseFloat(d.change_abs) || 0;
      const cls = abs > 0 ? 'change-up' : (abs < 0 ? 'change-down' : 'change-none');
      const sign = abs > 0 ? 'â–²' : (abs < 0 ? 'â–¼' : '-');

      html += `
        <div class="item-card">
          <div class="item-name">${name}</div>
          <div class="item-price">${d.price || '-'}<small>(${UNITS[name]})</small></div>
          <div class="item-change ${cls}">${sign} ${Math.abs(abs)} (${d.change_pct}%)</div>
          <div class="item-comm">${d.commentary || 'ì½”ë©˜í„°ë¦¬ ì—†ìŒ'}</div>
          <button class="btn btn-edit-small" onclick="quickEdit('${name}', '${d.commentary || ''}')">ìˆ˜ì •</button>
        </div>
      `;
    });
    document.getElementById('mainContent').innerHTML = html;
  }

  // âœ¨ ìŠ¤ë§ˆíŠ¸ íŒŒì„œ ë¡œì§
  function parseSmartText() {
    const text = document.getElementById('smartInput').value;
    const regex = new RegExp(`(${ITEMS.join('|')})`, 'gi');
    let sections = text.split(itemRegex = new RegExp(`(${ITEMS.join('|')})`, 'gi'));

    for (let i = 1; i < sections.length; i += 2) {
      const name = sections[i].toUpperCase();
      const content = sections[i+1];
      const pMatch = content.match(/1\.ê°€ê²©\s*[\r\n]+([\d.,]+)/i) || content.match(/(\d+(\.\d+)?)/);
      const cMatch = content.match(/2\.ì½”ë©˜í„°ë¦¬\s*[\r\n]+([\s\S]+?)(?=\n\d\.|$)/i);
      
      if(pMatch) document.getElementById('modal_price_'+name).value = pMatch[1].replace(/,/g,'');
      if(cMatch) document.getElementById('modal_comm_'+name).value = cMatch[1].trim();
    }
  }

  // ğŸ“‹ ì¹´í†¡ ì „ì†¡ìš© í…ìŠ¤íŠ¸ ë³µì‚¬ ê¸°ëŠ¥
  function copyToClipboard() {
    if(!currentWeekData) return;
    let text = `[LAM Weekly Chemical Brief - ${currentWeekData.week}]\n\n`;
    ITEMS.forEach(name => {
      const d = currentWeekData.items[name];
      const abs = parseFloat(d.change_abs) || 0;
      const sign = abs > 0 ? 'â–²' : (abs < 0 ? 'â–¼' : '-');
      text += `${name}: ${d.price} (${sign}${Math.abs(abs)})\n- ${d.commentary || 'ë‚´ìš© ì—†ìŒ'}\n\n`;
    });
    
    navigator.clipboard.writeText(text.trim()).then(() => showToast('âœ… ì¹´í†¡ìš© í…ìŠ¤íŠ¸ ë³µì‚¬ ì™„ë£Œ!'));
  }

  function quickEdit(name, comm) {
    const newComm = prompt(`${name} ì½”ë©˜í„°ë¦¬ ìˆ˜ì •:`, comm);
    if(newComm !== null) {
      callGAS({action:'updateCommentary', week:currentWeekData.week, item:name, commentary:newComm})
      .then(res => { if(res.success) { showToast('ìˆ˜ì • ì™„ë£Œ'); loadWeekData(currentWeekData.week); }});
    }
  }

  function openModal() {
    document.getElementById('modalWeek').value = new Date().getFullYear() + '-W' + String(Math.ceil((new Date() - new Date(new Date().getFullYear(),0,1))/604800000)).padStart(2,'0');
    document.getElementById('modalOverlay').classList.add('active');
  }

  function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

  function buildModalRows() {
    document.getElementById('modalItemRows').innerHTML = ITEMS.map(name => `
      <div class="modal-grid">
        <div class="modal-label">${name}</div>
        <input type="number" id="modal_price_${name}" class="modal-input" placeholder="ê°€ê²©">
        <input type="text" id="modal_comm_${name}" class="modal-input" placeholder="ì½”ë©˜í„°ë¦¬ ì…ë ¥">
      </div>
    `).join('');
  }

  async function saveEntry() {
    const week = document.getElementById('modalWeek').value;
    const items = {};
    ITEMS.forEach(n => { items[n] = { price: document.getElementById('modal_price_'+n).value, commentary: document.getElementById('modal_comm_'+n).value }; });
    const res = await callGAS({action:'saveEntry', data: {week, items}});
    if(res.success) { showToast('âœ… DB ì €ì¥ ì™„ë£Œ'); closeModal(); loadWeekList(); }
  }

  function refreshData() { loadWeekList(); showToast('â†» ë°ì´í„° ìƒˆë¡œê³ ì¹¨'); }

  function showToast(msg) {
    const t = document.getElementById('toastMsg');
    t.textContent = msg; t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 3000);
  }
</script>
</body>
</html>
