<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>LAM Weekly Market Brief</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* ── 이미지 스타일 및 오렌지 테마 적용 ── */
    :root { --orange: #FF8C00; --bg-gray: #f4f7f9; --bg-label: #fff9f0; --border-label: #ffe8cc; --up: #e74c3c; --down: #3498db; }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
    body { background-color: var(--bg-gray); color: #2d3436; }

    /* ── 헤더 ── */
    .header { background: white; padding: 15px 25px; border-bottom: 4px solid var(--orange); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .logo { font-size: 1.5em; font-weight: 950; display: flex; align-items: center; gap: 10px; }
    .logo span { color: var(--orange); }
    .toolbar { display: flex; gap: 8px; }
    .t-btn { padding: 8px 15px; border-radius: 8px; border: 1px solid #d1d8e0; background: white; cursor: pointer; font-weight: 800; font-size: 0.85em; display: flex; align-items: center; gap: 6px; }

    /* ── 카드형 리스트 (이미지 요청 사항 반영) ── */
    .container { max-width: 1400px; margin: 0 auto; padding: 25px; }
    .report-card { background: white; border-radius: 15px; padding: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .item-row { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 0; border: 1.5px solid #edf2f7; }
    
    /* 품목명: 베이지색 라운드 박스 */
    .name-box { flex: 0 0 170px; height: 75px; display: flex; align-items: center; justify-content: center; background: var(--bg-label); border: 2px solid var(--border-label); border-radius: 10px; font-size: 1.5em; font-weight: 950; color: #444; }
    
    .price-col { flex: 0 0 180px; text-align: right; padding-right: 25px; }
    .p-main { font-size: 2.1em; font-weight: 950; display: block; line-height: 1; }
    .change-badge { margin-top: 8px; display: inline-block; padding: 4px 10px; border-radius: 6px; font-weight: 800; font-size: 1em; }

    /* 코멘트: 좌측 주황색 굵은 선 */
    .comm-col { flex: 1; font-size: 1.35em; font-weight: 900; line-height: 1.6; white-space: pre-wrap; padding: 5px 25px; border-left: 6px solid var(--orange); margin: 0 20px; }
    .action-col { flex: 0 0 430px; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }

    /* ── 그래프 ── */
    #wti_chart_div { width: 260px; height: 130px; }
    .wti-table { font-size: 0.72em; width: 120px; border-collapse: collapse; }
    .wti-table td { border: 1px solid #f1f5f9; padding: 3px; text-align: center; font-weight: 800; }

    /* ── 모달 및 알림 ── */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
    .modal-content { background: white; width: 95%; max-width: 650px; padding: 30px; border-radius: 20px; }
    .m-input { width: 100%; padding: 15px; margin-bottom: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1.1em; }
    #toast { visibility: hidden; position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); color: #fff; padding: 15px 40px; border-radius: 50px; z-index: 5000; font-weight: 900; }
    #toast.show { visibility: visible; animation: fadein 0.5s; }

    @media (max-width: 1200px) { .item-row { flex-direction: column; align-items: flex-start; gap: 15px; } .name-box, .price-col, .comm-col, .action-col { width: 100%; text-align: left; padding: 0; flex: none; border: none; margin: 0; } }
    .capture-mode { width: 1800px !important; } .capture-mode .item-row { flex-direction: row !important; display: flex !important; }
  </style>
</head>
<body>

  <header class="header">
    <div class="logo">LAM <span>Weekly Brief</span></div>
    <div class="toolbar">
      <button class="t-btn btn-kakao" onclick="copyToKakao()"><i class="fas fa-comment"></i> 카톡복사</button>
      <button class="t-btn btn-img" onclick="takeCapture()"><i class="fas fa-file-image"></i> 이미지 저장</button>
      <select id="weekSelector" onchange="loadData(this.value)" style="padding: 8px; border-radius: 6px; font-weight: 800; border: 2px solid var(--orange); outline:none;"></select>
      <button class="t-btn" style="background:#ff4757; color:white; border:none;" onclick="openNewReport()">+ NEW</button>
    </div>
  </header>

  <div class="container">
    <div class="report-card" id="captureArea">
      <div class="report-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; border-bottom:2px solid #eee; padding-bottom:15px;">
        <h2 style="font-weight:900;">Weekly Market Status Report</h2>
        <div id="displayWeek" style="font-weight:800; color:#666;">Week: 2026-W00</div>
      </div>
      <div id="mainRows"></div>
    </div>
  </div>

  <div id="mModal" class="modal">
    <div class="modal-content">
      <h2 id="mTitle" style="margin-bottom:20px; border-bottom:3px solid var(--orange); padding-bottom:10px;">데이터 관리</h2>
      <div id="mFields"></div>
      <button id="mSaveBtn" style="background:var(--orange); color:white; border:none; padding:18px; border-radius:12px; width:100%; font-weight:950; cursor:pointer; font-size:1.3em;">업데이트 완료</button>
      <button onclick="closeModal()" style="width:100%; margin-top:15px; border:none; background:none; color:#94a3b8; cursor:pointer; font-weight:bold;">취소하기</button>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // ★ 본인의 배포 URL로 교체하세요 ★
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbw7AHNCsUSqvHlFouto8iYQfI26wr9SttYXm6lgDpc2kF8AJAcIA7cVvwEXOiEC1ONQ/exec';
    const ITEMS = ['WTI', 'Styrene', 'Acrylonitrile', 'Butadiene', 'BPA', 'MMA'];
    const UNITS = { 'WTI': '$/bbl', 'Styrene': '$/MT', 'Acrylonitrile': '$/MT', 'Butadiene': '$/MT', 'BPA': '$/MT', 'MMA': '$/MT' };
    let currentData = null;
    let chartType = 'LineChart';

    google.charts.load('current', {packages: ['corechart']});
    window.onload = init;

    // 외부용 POST 통신 함수 (이게 핵심입니다!)
    async function callGAS(action, params) {
      const response = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: action, params: params })
      });
      return await response.json();
    }

    async function init() {
      const curWeek = getCurrentISOWeek();
      const sel = document.getElementById('weekSelector');
      let opt = "";
      for (let y = 2033; y >= 2026; y--) {
        for (let w = 52; w >= 1; w--) {
          let ws = (w < 10) ? "0" + w : w;
          let val = `${y}-W${ws}`;
          opt += `<option value="${val}">${val}</option>`;
        }
      }
      sel.innerHTML = opt;
      const res = await callGAS('getWeekList', {});
      if(res.weeks && res.weeks.length > 0) {
        sel.value = res.weeks.indexOf(curWeek) !== -1 ? curWeek : res.weeks[0];
        loadData(sel.value);
      }
    }

    function getCurrentISOWeek() {
      const d = new Date(); d.setHours(0,0,0,0);
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      const year = d.getFullYear();
      const week = Math.ceil((((d - new Date(year, 0, 1)) / 86400000) + 1) / 7);
      return year + "-W" + (week < 10 ? '0' + week : week);
    }

    async function loadData(week) {
      document.getElementById('displayWeek').innerText = "Week: " + week;
      const res = await callGAS('getWeekData', week);
      if(res.success) { currentData = res.data; render(res.data); }
    }

    function render(data) {
      const list = document.getElementById('mainRows');
      list.innerHTML = ITEMS.map(name => {
        const i = data.items[name];
        const diff = parseFloat(i.change_abs);
        const bg = diff > 0 ? 'up-bg' : (diff < 0 ? 'down-bg' : 'flat-bg');
        const isWTI = (name === 'WTI');
        return `
          <div class="item-row">
            <div class="name-box">${name}</div>
            <div class="price-col">
              <span class="p-main" style="color:${diff>0?'#e74c3c':(diff<0?'#3498db':'#2d3436')}">${i.price.toLocaleString()}<small style="font-size:0.4em; color:#999;">(${UNITS[name]})</small></span>
              <div class="change-badge ${bg}">${diff>0?'▲':(diff<0?'▼':'-')} ${Math.abs(diff).toFixed(1)} (${i.change_rate}%)</div>
            </div>
            <div class="comm-col">${i.commentary || '분석 리포트가 없습니다.'}</div>
            <div class="action-col">
              ${isWTI ? `
                <div style="display:flex; gap:4px; margin-bottom:5px;"><button class="t-btn" style="padding:2px 8px; font-size:10px;" onclick="setChart('LineChart')">Line</button><button class="t-btn" style="padding:2px 8px; font-size:10px;" onclick="setChart('AreaChart')">Area</button><button class="t-btn" style="padding:2px 8px; font-size:10px;" onclick="setChart('ColumnChart')">Bar</button></div>
                <div style="display:flex; align-items:center; gap:10px;"><table class="wti-table" id="wti_list_view"></table><div id="wti_chart_div"></div></div>
                <button class="t-btn" style="font-size:11px; margin-top:5px;" onclick="openWtiEdit()">6거래일 통합 수정</button>
              ` : `<button class="t-btn" style="font-size:11px;" onclick="openSingleEdit('${name}')">수정</button>`}
            </div>
          </div>
        `;
      }).join('');
      google.charts.setOnLoadCallback(drawWti);
    }

    function setChart(t) { chartType = t; drawWti(); }

    async function drawWti() {
      const history = await callGAS('getWtiHistory', {});
      if(!history || !history.length) return;
      document.getElementById('wti_list_view').innerHTML = history.map(h => `<tr><td>${h.label}</td><td style="font-weight:900;">${h.price}</td></tr>`).join('');
      const dt = new google.visualization.DataTable();
      dt.addColumn('string', '날짜'); dt.addColumn('number', '가격'); dt.addColumn({type: 'string', role: 'annotation'});
      history.forEach(h => dt.addRow([h.label, h.price, h.price.toString()]));
      new google.visualization[chartType](document.getElementById('wti_chart_div')).draw(dt, {
        legend: 'none', colors: ['#000000'], chartArea: {width: '85%', height: '70%'},
        annotations: { alwaysOutside: true, textStyle: { fontSize: 10, bold: true } },
        vAxis: { gridlines: {color: 'transparent'}, textPosition: 'none' },
        hAxis: { textStyle: {fontSize: 9} }
      });
    }

    function openSingleEdit(n) {
      const i = currentData.items[n];
      document.getElementById('mTitle').innerText = n + " 리포트 수정";
      document.getElementById('mFields').innerHTML = `<input type="number" step="0.01" id="mP" class="m-input" value="${i.price}"><textarea id="mC" class="m-input" style="height:220px; font-weight:900;">${i.commentary}</textarea>`;
      document.getElementById('mSaveBtn').onclick = async () => {
        msg("저장 중...", "var(--orange)");
        await callGAS('saveData', { week: currentData.week, item: n, price: document.getElementById('mP').value, commentary: document.getElementById('mC').value });
        msg("✓ 완료", "#27ae60"); closeModal(); loadData(currentData.week);
      };
      document.getElementById('mModal').style.display = 'flex';
    }

    function openWtiEdit() {
      document.getElementById('mTitle').innerText = "WTI 6거래일 통합 수정";
      let h = `<div style="background:#f8fafc; padding:15px; border-radius:12px; margin-bottom:15px;"><strong>영업일 6일 역산 (금-목-수-화-월-전주금)</strong>`;
      let dates = []; let tempD = new Date();
      while(dates.length < 6) { if(tempD.getDay() !== 0 && tempD.getDay() !== 6) dates.push(new Date(tempD).toISOString().split('T')[0]); tempD.setDate(tempD.getDate() - 1); }
      dates.reverse().forEach((d, i) => h += `<div style="display:flex; gap:5px; margin-top:8px;"><input type="date" id="wd_${i}" class="m-input" value="${d}" style="flex:1.2; margin:0;"><input type="number" step="0.01" id="wp_${i}" class="m-input" placeholder="가격" style="flex:1; margin:0;"></div>`);
      h += `</div><input type="number" id="wP" class="m-input" value="${currentData.items['WTI'].price}"><textarea id="wC" class="m-input" style="height:120px; font-weight:900;">${currentData.items['WTI'].commentary}</textarea>`;
      document.getElementById('mFields').innerHTML = h;
      document.getElementById('mSaveBtn').onclick = async () => {
        msg("데이터 전송 중...", "var(--orange)");
        let es = []; for(let i=0; i<6; i++) { let p = document.getElementById("wp_"+i).value; if(p) es.push({date: document.getElementById("wd_"+i).value, price: parseFloat(p)}); }
        await callGAS('saveDailyWtiBulk', es);
        await callGAS('saveData', { week: currentData.week, item: 'WTI', price: document.getElementById('wP').value, commentary: document.getElementById('wC').value });
        msg("✓ 완료", "#27ae60"); closeModal(); loadData(currentData.week);
      };
      document.getElementById('mModal').style.display = 'flex';
    }

    function openNewReport() {
      const cur = getCurrentISOWeek();
      document.getElementById('mTitle').innerText = "신규 리포트 생성";
      let h = `<select id="nw" class="m-input" style="font-weight:900;"><option value="${cur}">${cur}</option></select>`;
      ITEMS.forEach(n => h += `<div style="font-weight:800; margin-top:10px; color:#666;">${n}</div><div style="display:flex; gap:10px;"><input type="number" id="np_${n}" class="m-input" placeholder="가격" style="flex:1;"><input type="text" id="nc_${n}" class="m-input" placeholder="코멘트" style="flex:2.5;"></div>`);
      document.getElementById('mFields').innerHTML = h;
      document.getElementById('mSaveBtn').onclick = async () => {
        msg("생성 중...", "var(--orange)");
        const w = document.getElementById('nw').value;
        for(let n of ITEMS) { await callGAS('saveData', { week: w, item: n, price: document.getElementById('np_'+n).value, commentary: document.getElementById('nc_'+n).value }); }
        msg("✓ 성공", "#27ae60"); closeModal(); init();
      };
      document.getElementById('mModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('mModal').style.display = 'none'; }
    function msg(m, bg) { const t = document.getElementById('toast'); t.innerText = m; t.style.background = bg; t.className = 'show'; setTimeout(()=>t.className='', 2500); }
    function takeCapture() { 
      const area = document.getElementById('captureArea'); area.classList.add('capture-mode');
      html2canvas(area, { scale: 2.5, useCORS: true, width: 1800 }).then(canvas => {
        const a = document.createElement('a'); a.download = `LAM_Report_${currentData.week}.png`; a.href = canvas.toDataURL(); a.click();
        area.classList.remove('capture-mode');
      });
    }
    function copyToKakao() {
      let t = `[LAM Weekly Brief - ${currentData.week}]\n\n`;
      ITEMS.forEach(n => { const i = currentData.items[n]; t += `${n}: ${i.price} (${i.change_abs > 0 ? '▲':'▼'}${Math.abs(i.change_abs).toFixed(1)})\n- ${i.commentary}\n\n`; });
      navigator.clipboard.writeText(t).then(() => msg('✓ 복사됨', '#27ae60'));
    }
  </script>
</body>
</html>
